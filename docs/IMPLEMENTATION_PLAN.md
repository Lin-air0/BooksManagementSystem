# 图书管理系统功能问题修复计划

## 概述

根据测试反馈，当前图书管理系统存在5个功能问题需要修复。本计划将这些问题拆分为三个阶段进行修复，每个阶段聚焦于特定的问题集合，确保修复工作有序、高效进行。

## 第0阶段：API响应格式统一和字段映射修复
**目标**：统一前后端API响应格式，修复字段映射不一致问题

**验收标准**：
- 所有前端组件使用统一的{code, data, msg}响应格式
- 修正字段映射：book_id→id, reader_id→id, borrow_id→id
- 统一使用英文状态值(borrowed/returned/overdue)
- 移除冗余的字段回退逻辑
- 修复分页参数错误导致的400错误

**测试用例**：
1. 验证所有API接口响应格式一致
2. 验证前端组件正确解析后端字段
3. 验证状态值统一为英文格式
4. 验证分页参数限制（pageSize ≤ 100）

**需要修改的文件**：
- frontend/src/utils/api.js - 优化响应拦截器
- frontend/src/views/BookList.vue - 修复图书列表字段映射
- frontend/src/views/BorrowRecord.vue - 修复借阅记录字段映射
- frontend/src/views/Home.vue - 修复仪表盘统计API响应
- frontend/src/views/ReaderManage.vue - 修复读者管理字段映射

**状态**：已完成 ✅

**完成详情**：
- 已统一API响应格式为{code, data, msg}
- 已修复所有前端组件的字段映射问题
- 已标准化状态值为英文格式
- 已修复分页参数错误：将pageSize从1000改为100，解决400错误
- 已添加useMockData()方法便于开发测试
- 已提交代码到feature/api-response-fix分支

## 第1阶段：库存和归还功能修复

**目标**：解决库存字段一致性问题和归还功能中读者ID验证失效问题

**验收标准**：
- 图书查询界面和图书管理界面显示的库存信息保持一致
- 归还图书时，系统必须验证读者ID和借阅ID的关联性
- 所有涉及库存的API和前端组件使用统一的库存字段

**测试用例**：
1. 在图书查询界面和图书管理界面查看同一本书的库存信息，验证显示一致 ✅
2. 尝试使用错误的读者ID归还图书，验证系统拒绝操作 ✅
3. 使用正确的读者ID和借阅ID归还图书，验证归还成功且库存正确更新 ✅

**需要修改的文件**：
1. `frontend/src/views/BookList.vue` - 已正确显示available字段作为"可借数量"
2. `backend/src/routes/borrows.js` - 已正确实现borrow_id + reader_id双重验证
3. `backend/src/routes/books.js` - 已统一返回stock和available字段

**状态**：已完成 ✅

**验收标准**：
- [x] 库存字段命名统一（available 表示可借数量，stock 表示总库存）
- [x] 归还时正确更新库存（available + 1）
- [x] 归还时验证读者ID与借阅记录匹配
- [x] 归还成功后刷新借阅列表
- [x] 归还失败时提供清晰的错误提示

**测试用例**：
- [x] 测试归还后库存正确更新
- [x] 测试归还时读者ID验证
- [x] 测试重复归还的处理
- [x] 测试归还失败时的错误提示

**完成情况**：
- ✅ 库存字段命名统一（available/stock）
- ✅ 归还功能完整实现（包含读者ID校验、事务处理、错误处理）
- ✅ 事务处理确保数据一致性（START TRANSACTION, COMMIT, ROLLBACK）
- ✅ 错误处理机制完善（具体错误码和提示信息）
- ✅ 用户体验优化（模态框、加载状态、成功/失败提示）

**验证结果**：
- ✅ 字段命名一致性验证通过
- ✅ 读者ID验证逻辑正确（borrows.js第200-400行已完整实现）
- ✅ 事务安全性验证通过（使用数据库事务确保一致性）
- ✅ 错误提示用户体验良好（具体错误信息返回给前端）

**修复详情**：
- **后端修复**：归还API已实现完整的参数验证、读者ID校验、事务处理和库存更新
- **前端修复**：归还流程已优化，包含读者ID输入验证、借阅记录匹配、错误处理
- **数据一致性**：使用数据库事务确保归还操作的原子性
- **用户体验**：提供清晰的错误提示和成功反馈

## 第2阶段：读者管理功能修复

**目标**：解决新增读者时ID生成规则不明确和读者删除功能异常的问题

**验收标准**：
- [x] 新增读者时界面明确提示"ID由系统自动生成"
- [x] 学号重复时返回明确错误提示
- [x] 删除有未还图书的读者时阻止删除并给出提示

**测试用例**：
1. ✅ 新增读者时界面显示"ID由系统自动生成"提示
2. ✅ 使用重复学号新增读者应返回"学号已存在"错误
3. ✅ 删除无未还记录的读者应成功
4. ✅ 删除有未还记录的读者应被阻止并提示原因

**需要修改的文件**：
1. `frontend/src/views/ReaderManage.vue` - 添加读者ID生成规则提示
2. `backend/src/routes/readers.js` - 检查并修复删除读者的校验逻辑

**状态**：已完成 ✅
**修复详情**：
- **前端修复**：
  - 在新增/编辑读者表单中添加明确的ID生成提示
  - 优化错误处理，针对学号重复返回更友好的提示
  - 增强用户体验，减少用户困惑
- **后端修复**：
  - 修复参数验证逻辑，避免undefined参数导致的500错误
  - 完善学号唯一性校验，返回明确的重复学号提示
  - 优化删除逻辑，确保有未还图书记录的读者无法被删除
  - 增强错误处理，提供更有针对性的错误信息
- **数据一致性**：确保读者删除时的外键约束检查
- **用户体验**：通过清晰的提示和错误信息提升用户操作体验

## 第3阶段：借阅记录页面功能完善

**目标**：解决借阅记录页面缺少归还入口的问题

**验收标准**：
- ✅ 借阅记录页面中所有状态为"借阅中"或"逾期"的记录都显示"还书"按钮
- ✅ 点击"还书"按钮能够正确触发归还流程
- ✅ 归还成功后，借阅记录的状态应自动更新

**测试用例**：
1. ✅ 进入借阅记录页面，验证未还记录均显示"还书"按钮
2. ✅ 点击"还书"按钮，验证归还流程正常触发
3. ✅ 完成归还后，验证借阅记录状态更新为"已归还"

**需要修改的文件**：
1. `frontend/src/views/BorrowRecord.vue` - 检查并修复还书按钮的显示和功能

**状态**：已完成 ✅
**完成情况**：
- ✅ 字段命名验证完成（前后端一致）
- ✅ 功能测试执行完成（借阅/归还库存更新正常）
- ✅ 触发器与代码同步验证完成（无冲突）
- ✅ 库存约束测试已完成

**验证结果**：
- 字段命名：前后端完全一致（stock/available）
- 库存更新：借阅扣减1，归还增加1，功能正常
- 数据一致性：事务处理确保数据安全
- 库存约束边界测试：已通过

## 问题详情与修复方案

### 1. 库存字段一致性问题

**问题描述**：图书查询界面和图书管理界面都涉及"库存"相关展示，但两个界面显示的库存数值不一致，且不确定这些字段中哪个是实际用于借阅/归还时计算的有效字段。

**原因分析**：
- 在`backend/src/routes/books.js`中定义了`stock`和`available`两个库存相关字段
- 在`backend/src/routes/borrows.js`中，借阅和归还时更新的都是`available`字段
- 在`frontend/src/views/BookList.vue`中显示的是`book.stock`字段

**修复方案**：
1. 统一使用`available`字段作为实际可借数量的字段
2. 修改前端界面，将显示的字段改为`available`并标注为"可借数量"
3. 确保所有涉及库存计算的API操作都使用`available`字段

### 2. 归还功能中读者ID验证失效

**问题描述**：在图书管理界面的"归还"操作流程中，故意输入错误的读者ID（不存在的ID），但输入正确的借阅ID，系统仍显示归还成功。

**原因分析**：
- 在`frontend/src/views/BookList.vue`的归还弹窗中，只要求输入借阅ID
- 在`backend/src/routes/borrows.js`的归还API中，只检查了`borrow_id`的有效性，没有对读者ID进行验证

**修复方案**：
1. 修改前端归还弹窗，增加读者ID输入框
2. 修改后端归还API，要求同时提供`borrow_id`和`reader_id`
3. 在API中添加逻辑，验证`reader_id`与`borrow_id`的关联性

### 3. 新增读者时ID的生成规则

**问题描述**：新增读者时，读者ID未通过手动输入，推测为系统自动分配，但生成规则不明确。

**原因分析**：
- 在`backend/src/routes/readers.js`中，新增读者时使用了MySQL的自增ID机制（通过`result.insertId`获取）
- 系统对学号（student_id）有唯一性校验，但前端界面未明确提示读者ID的生成方式

**修复方案**：
1. 在前端新增读者界面添加明确提示，说明读者ID由系统自动生成
2. 保持对学号唯一性的校验逻辑

### 4. 借阅记录页面缺少归还入口

**问题描述**：在借阅记录查询/列表页面，无法从该页面直接发起归还操作。

**原因分析**：
- 查看`frontend/src/views/BorrowRecord.vue`，文件中已包含"还书"按钮的代码，但可能存在逻辑问题导致按钮不可见或功能失效

**修复方案**：
1. 检查并修复`BorrowRecord.vue`中还书按钮的显示逻辑
2. 确保"还书"按钮对所有状态为"借阅中"或"逾期"的记录可见
3. 验证点击"还书"按钮能够正确触发归还流程

### 5. 读者删除功能异常（无未还记录仍无法删除）

**问题描述**：即使读者没有未还的借阅记录，仍无法删除。

**原因分析**：
- 在`backend/src/routes/readers.js`中，删除读者时会检查是否有未归还的借阅记录
- 可能存在逻辑错误或查询条件不准确导致校验失败

**修复方案**：
1. 检查并修复`readers.js`中删除读者的校验逻辑
2. 确保查询条件准确，正确识别未归还的借阅记录
3. 如确认无未还记录，应允许删除操作正常执行